```markdown
# Project Thunder 프롬프팅 설계 문서 v1.0 (SSOT)
## “Stability-First, Performance-Second Prompt Engineering for Map-Reduce Reasoning” [file:1]

> 본 문서는 Project Thunder v3.0의 **프롬프팅(LLM 호출)**만을 다룬다. [file:1]  
> 목표 우선순위는 (1) 안정적인 출력(파싱 가능/재현 가능/근거 강제) (2) 성능(정확도·비용·지연 최적화)이다. [file:1]

---

## 1) 공통 원칙 (Stability First)
### 1.1 구조화 출력 강제 (JSON Schema)
Thunder의 모든 LLM 호출은 기본적으로 자유 텍스트 출력을 금지하고, 구조화 출력(JSON)만 허용한다. [file:1]  
특히 Phase 2(신호 추출)와 Phase 4(최종 리포트)는 `response_mime_type: application/json`과 `response_json_schema`를 사용해 스키마 준수를 강제한다. [file:1]

### 1.2 “근거 없으면 제외”를 출력 제약으로 만든다
Thunder의 핵심 원칙은 **No Evidence, No Output**이며, 이는 “규칙 문장”이 아니라 **스키마 제약**으로 강제한다. [file:1]  
즉 professor_mentioned / likely / trap_warnings의 각 item은 `audio_refs[]`와 `citations[]`를 필수(required)로 두고, 근거가 부족한 내용은 3개 배열에 넣지 않으며 `warnings[]`로만 배출한다. [file:1]

### 1.3 프롬프트 블록 표준 (항상 동일 순서)
모든 프롬프트는 아래 태그/순서를 고정한다(긴 컨텍스트에서도 재현성/안정성 강화). [file:1]
- `[ROLE]`
- `[NON_NEGOTIABLES]`
- `[LANGUAGE_POLICY]` *(v1.0에서 추가: “프롬프트 영어, 최종 사용자 텍스트 한국어” 정책)*
- `[INPUT]`
- `[TASK]`
- `[OUTPUT_SCHEMA]`
- `[NOW_OUTPUT]` *(항상 맨 마지막)* [file:1]

### 1.4 서버 의미 검증(semantic validation) 표준
스키마 준수는 “형식”만 보장하므로, 서버는 의미 검증을 수행하고 실패 시 1회 재시도 후 무효화한다. [file:1]
- 시간: `t0_sec <= t1_sec`, 음수/NaN 금지
- 참조 무결성: `audio_refs.signal_id` 존재 여부, `citations.chunk_id` 존재 여부
- 근거 강제: 근거 없는 항목이 3개 배열에 들어오면 제거/재시도
- 중복 방지: 동일 `signal_id`가 여러 item에 반복 포함되면 재시도 유도(또는 서버가 자동 병합 정책) [file:1]

---

## 2) 언어 정책 (Prompt EN, Output KO)
LLM의 지시문 이해도와 안정성을 위해 **프롬프트(규칙/역할/금지사항)는 영어**로 작성하되, 최종 사용자는 한국어이므로 **사용자 노출 텍스트는 한국어로 강제**한다. [file:1]

### 2.1 고정 원칙
- 프롬프트 본문(ROLE/NON_NEGOTIABLES/TASK)은 영어로 작성한다. [file:1]
- JSON key(스키마 키)는 고정이며 다국어로 바꾸지 않는다(파서/클라이언트 안정성). [file:1]
- JSON value 중 “사용자에게 보이는 텍스트”는 한국어로 출력한다. [file:1]

### 2.2 한국어 강제 대상(Phase 4 필수)
아래 필드 값은 반드시 한국어로 작성한다.
- `title`, `why`, `warnings[]`
- trap_warnings: `pitfall`, `why_confusing`, `recommended_answer_style`, `correct_answer_core` [file:1]

예외(허용):
- 전공 고유명사, 수식, 기호, 표준 약어(예: FFT, Gauss’s law)는 원문(영문) 유지 가능하되 문장 구조는 한국어를 기본으로 한다. [file:1]

---

## 3) 입력 데이터 포맷 표준 (Reduce 안정성의 핵심)
Phase 4는 한 번에 통합 추론하므로 입력 포맷이 깨지면 근거 매핑이 무너진다. [file:1]

### 3.1 Signals Timeline 포맷
서버가 시간순 정렬을 수행하고 모델은 “정렬된 타임라인”만 받는다. [file:1]  
토큰 효율을 위해 한 신호를 최소 블록으로 직렬화한다. [file:1]

예시:
```text
[SIGNALS_TIMELINE]
- signal_id=... audio_chunk_id=... t=125.3~142.7 type=hint importance=0.90
  content="3장 쿨롱 법칙 유도 중요(서술형 출제 예고)."
  queries=["Coulomb law derivation","Chapter 3 Coulomb"]
- signal_id=... audio_chunk_id=... t=890.1~920.5 type=trap importance=0.80
  content="정의에서 '모든' vs '일부' 혼동 주의."
  queries=["necessary and sufficient condition","definition all vs some"]
```

### 3.2 References Dedup Pool 포맷(필수)
References는 “텍스트 뭉치”가 아니라, **식별자/메타 포함 블록**으로 제공한다(근거 매핑을 기계적으로 가능하게 함). [file:1]  
모델은 citations에 이 헤더 메타를 **그대로 복사**해야 하며, 새로 발명하면 안 된다. [file:1]

예시:
```text
[REFERENCES_DEDUP]
[[CHUNK chunk_id=... source_id=... page=45-47 anchor="Chapter 2 > Gauss Law"]]
<CONTENT>
...교재 본문...
</CONTENT>

[[CHUNK chunk_id=... source_id=... page=102-103 anchor="Chapter 3 > Coulomb Law > Derivation"]]
<CONTENT>
...교재 본문...
</CONTENT>
```

---

## 4) Phase별 프롬프트(실사용 템플릿)
본 섹션은 실제 운영에서 “그대로 복사해 쓰는” 템플릿을 제공한다. [file:1]

### 4.1 Phase 2 (Audio Mapper: Signal + Search Intent)
#### Phase 2 System Prompt (EN)
```text
[ROLE]
You are an exam-focused lecture analyzer. Your job is ONLY to extract exam-relevant signals from lecture audio and generate textbook search intents.

[NON_NEGOTIABLES]
- Output MUST be valid JSON that matches the provided JSON Schema. No markdown, no extra keys, no explanations.
- Do NOT make any final exam predictions. This is Phase 2 only (no final classification for the report).
- Do NOT guess textbook pages, citations, source_id, or chunk_id. You only have the audio.
- Each signal MUST include 2 to 6 search_queries. 0 is not allowed.
- content must be: one sentence + (optional) one short reason in parentheses, max 160 Korean characters total.
- search_queries must be keyword-style (no long questions). Prefer official terms, formulas, chapter hints, English synonyms.
- If uncertain, produce a conservative signal with lower importance. Never fabricate evidence.

[LANGUAGE_POLICY]
- The JSON keys must follow the schema exactly.
- The value of signals[].content MUST be written in Korean.
- search_queries may be Korean or English keywords (English is encouraged for retrieval), but do NOT write long English sentences.

[INPUT]
You will receive audio (or an audio reference) plus audio_chunk_id and time context.

[TASK]
1) Extract signals: explicit hints, repeated emphasis, definitions, derivations, exceptions, common pitfalls.
2) For each signal, generate search_queries that would retrieve relevant textbook content.

[OUTPUT_SCHEMA]
Return JSON matching the schema.

[NOW_OUTPUT]
Return only the JSON.
```

#### Phase 2 User Prompt (EN wrapper, values may include KO)
```text
[INPUT]
subject="{SUBJECT_NAME}"
exam_window="{EXAM_WINDOW}"  # midterm|final|custom
audio_chunk_id="{AUDIO_CHUNK_ID}"
audio_duration_sec={DURATION_SEC}
professor_style_notes="{USER_NOTES}"

Audio:
{AUDIO_INPUT_OR_REFERENCE}

[TASK]
Extract signals + search intent as specified.
[NOW_OUTPUT]
```

#### Phase 2 response_json_schema
```json
{
  "type": "object",
  "additionalProperties": false,
  "required": ["signals"],
  "properties": {
    "signals": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "signal_type",
          "content",
          "search_queries",
          "audio_chunk_id",
          "t0_sec",
          "t1_sec",
          "importance"
        ],
        "properties": {
          "signal_type": { "type": "string", "enum": ["hint", "likely", "trap"] },
          "content": { "type": "string", "minLength": 1, "maxLength": 200 },
          "search_queries": {
            "type": "array",
            "minItems": 2,
            "maxItems": 6,
            "items": { "type": "string", "minLength": 2, "maxLength": 120 }
          },
          "audio_chunk_id": { "type": "string", "minLength": 8, "maxLength": 64 },
          "t0_sec": { "type": "number", "minimum": 0 },
          "t1_sec": { "type": "number", "minimum": 0 },
          "importance": { "type": "number", "minimum": 0, "maximum": 1 }
        }
      }
    }
  }
}
```

---

### 4.2 Phase 3 (Gatherer: Retrieval) — LLM 최소화(선택: Query Rewrite)
Phase 3는 DB/RPC 중심이며 LLM 개입을 최소화한다(안정성과 비용). [file:1]  
다만 선택적으로 “쿼리 리라이트”만 LLM로 수행할 수 있다. [file:1]

#### Phase 3 Query Rewrite System Prompt (EN)
```text
[ROLE]
You are a query rewrite helper for textbook retrieval.

[NON_NEGOTIABLES]
- Output MUST be valid JSON matching the schema. No extra text.
- Do NOT guess pages, citations, or textbook content.
- Output keyword-style queries only (no questions, no long sentences).
- Generate 3 to 5 rewritten queries.

[LANGUAGE_POLICY]
- Output rewritten_queries as short keywords.
- English keywords are preferred for retrieval, but Korean keywords are allowed if helpful.

[INPUT]
signal_content (Korean) + original_query (optional)

[TASK]
Rewrite into keyword queries likely to retrieve textbook content: synonyms, official term names, English variants, formula names.

[OUTPUT_SCHEMA]
Return JSON matching the schema.

[NOW_OUTPUT]
Return only the JSON.
```

#### Phase 3 Query Rewrite response_json_schema
```json
{
  "type": "object",
  "additionalProperties": false,
  "required": ["rewritten_queries"],
  "properties": {
    "rewritten_queries": {
      "type": "array",
      "minItems": 3,
      "maxItems": 5,
      "items": { "type": "string", "minLength": 2, "maxLength": 120 }
    }
  }
}
```

---

### 4.3 Phase 4 (Reducer: Global Reasoning) — 최종 Exam Report 생성
Phase 4는 세션 전체 신호 타임라인과 dedup된 교재 청크 풀을 모두 읽고, 한 번에 통합 추론해 최종 리포트를 생성한다. [file:1]  
Thunder는 JSON Schema 기반 구조화 출력과 “근거 없으면 제외”를 중심 가드레일로 둔다. [file:1]

#### Phase 4 System Prompt (EN)
```text
[ROLE]
You are the head teaching assistant for this course. You must create an evidence-based exam prediction report for Korean students.

[NON_NEGOTIABLES]
- Output MUST be valid JSON that matches the provided JSON Schema. No markdown, no extra keys, no explanations.
- No Evidence, No Output:
  - Every item in professor_mentioned/likely/trap_warnings MUST include audio_refs (min 1) AND citations (min 1).
  - If an item lacks evidence, DO NOT include it in the 3 arrays. Put a short note in warnings[] instead.
- citations MUST ONLY reference chunks that appear in [REFERENCES_DEDUP].
  - Copy chunk_id/source_id/page_start/page_end/anchor_path from the chunk header blocks.
  - Never invent IDs, pages, anchors, or source_id.
- audio_refs MUST ONLY reference signals that appear in [SIGNALS_TIMELINE].
  - Never invent signal_id or audio_chunk_id.
- Synthesis rule:
  - If multiple signals refer to the same topic, merge them into ONE item and include multiple audio_refs.
- Do not over-generate. If evidence is weak or mismatched, exclude the item.

[LANGUAGE_POLICY]
- JSON keys must remain exactly as the schema defines.
- All user-facing text VALUES must be written in Korean:
  - title, why, warnings[]
  - pitfall, why_confusing, recommended_answer_style, correct_answer_core
- English is allowed only for technical proper nouns, formulas, symbols, and standard acronyms, but the surrounding sentence must be Korean.
- Do NOT output any English-only paragraphs.

[INPUT]
You will receive:
- [SIGNALS_TIMELINE] (sorted)
- [REFERENCES_DEDUP] (deduplicated textbook chunks with metadata headers)

[TASK]
1) Synthesis: Group related signals into a single topic item.
2) Verification: For each topic, map to the best matching reference chunks (citations). If no direct match, exclude.
3) Classification:
   - professor_mentioned: explicit professor prediction
   - likely: repeated emphasis / high importance / strong textbook match
   - trap_warnings: mismatch, exceptions, confusing definitions, common pitfalls
4) Writing: Produce the final JSON report.

[OUTPUT_SCHEMA]
Return JSON matching the schema.

[NOW_OUTPUT]
Return only the JSON.
```

#### Phase 4 User Prompt (EN wrapper, inputs include KO)
```text
[INPUT]
session_id="{SESSION_ID}"
subject="{SUBJECT_NAME}"
exam_window="{EXAM_WINDOW}"
professor_style_notes="{USER_NOTES}"
scope_notes="{SCOPE_NOTES}"

[SIGNALS_TIMELINE]
{SIGNALS_TIMELINE_TEXT}

[REFERENCES_DEDUP]
{REFERENCES_DEDUP_TEXT}

[TASK]
Generate the final exam report JSON.
[NOW_OUTPUT]
```

#### Phase 4 response_json_schema (KO output, EN keys)
```json
{
  "type": "object",
  "additionalProperties": false,
  "required": ["professor_mentioned", "likely", "trap_warnings", "warnings"],
  "properties": {
    "warnings": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 200 }
    },
    "professor_mentioned": {
      "type": "array",
      "items": { "$ref": "#/$defs/ReportItem" }
    },
    "likely": {
      "type": "array",
      "items": { "$ref": "#/$defs/ReportItem" }
    },
    "trap_warnings": {
      "type": "array",
      "items": { "$ref": "#/$defs/TrapItem" }
    }
  },
  "$defs": {
    "AudioRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["audio_chunk_id", "t0_sec", "t1_sec", "signal_id"],
      "properties": {
        "audio_chunk_id": { "type": "string", "minLength": 8, "maxLength": 64 },
        "t0_sec": { "type": "number", "minimum": 0 },
        "t1_sec": { "type": "number", "minimum": 0 },
        "signal_id": { "type": "string", "minLength": 8, "maxLength": 64 }
      }
    },
    "Citation": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source_id", "page_start", "page_end", "anchor_path", "chunk_id"],
      "properties": {
        "source_id": { "type": "string", "minLength": 8, "maxLength": 64 },
        "page_start": { "type": "integer", "minimum": 1 },
        "page_end": { "type": "integer", "minimum": 1 },
        "anchor_path": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1, "maxLength": 120 }
        },
        "chunk_id": { "type": "string", "minLength": 8, "maxLength": 64 }
      }
    },
    "ReportItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "why", "confidence", "audio_refs", "citations"],
      "properties": {
        "title": { "type": "string", "minLength": 2, "maxLength": 60 },
        "why": { "type": "string", "minLength": 1, "maxLength": 260 },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "audio_refs": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/AudioRef" }
        },
        "citations": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Citation" }
        }
      }
    },
    "TrapItem": {
      "allOf": [
        { "$ref": "#/$defs/ReportItem" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["pitfall", "why_confusing", "recommended_answer_style", "correct_answer_core"],
          "properties": {
            "pitfall": { "type": "string", "minLength": 1, "maxLength": 180 },
            "why_confusing": { "type": "string", "minLength": 1, "maxLength": 260 },
            "recommended_answer_style": { "type": "string", "minLength": 1, "maxLength": 260 },
            "correct_answer_core": { "type": "string", "minLength": 1, "maxLength": 180 }
          }
        }
      ]
    }
  }
}
```

---

## 5) 재시도/가드레일 템플릿(SSOT)
동일 입력 1회 재시도 후 실패로 기록한다(무한 재시도 금지). [file:1]

### 5.1 T1: JSON 파싱 실패(Phase 2/4 공통)
```text
[NON_NEGOTIABLES]
- Your previous output was not valid JSON for the schema.
- Output ONLY valid JSON. No leading/trailing text. No code fences. No markdown.
- Do not change keys. Do not add commentary.

[NOW_OUTPUT]
Return only the JSON that matches the schema.
```

### 5.2 T3: citations 누락(Phase 4)
```text
[NON_NEGOTIABLES]
- Every item in professor_mentioned/likely/trap_warnings MUST include citations (min 1) AND audio_refs (min 1).
- If you cannot provide both, EXCLUDE the item and put a short note in warnings[].
- citations must be copied from [REFERENCES_DEDUP] headers only.

[LANGUAGE_POLICY]
- warnings[] must be written in Korean.

[NOW_OUTPUT]
Return only the corrected JSON.
```

---

## 6) 운영 체크리스트(요약)
- Phase 2/4는 `application/json` + `response_json_schema`로 구조화 출력 강제. [file:1]
- Phase 4 입력은 반드시 `[SIGNALS_TIMELINE]` + `[REFERENCES_DEDUP]` 블록 포맷 준수(식별자 유실 방지). [file:1]
- Phase 4는 No Evidence, No Output를 스키마(required) + 프롬프트 + 서버 의미 검증으로 삼중 강제. [file:1]
- 언어 정책: 프롬프트 영어, 사용자 노출 텍스트 값은 한국어 강제. [file:1]
```